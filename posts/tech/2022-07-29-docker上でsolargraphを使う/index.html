<!doctype html><html class=no-js lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Docker上でSolargraphを使う - チラ裏</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Docker上でSolargraphを使う"><meta property="og:description" content="LSPが登場し様々なLanguage Serverが使えるようになってから、開発する際にはとりあえずLanguage Serverを用意して使えるようにしています。"><meta property="og:type" content="article"><meta property="og:url" content="http://Kanon159.github.io/blog/posts/tech/2022-07-29-docker%E4%B8%8A%E3%81%A7solargraph%E3%82%92%E4%BD%BF%E3%81%86/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-31T00:00:00+09:00"><meta property="article:modified_time" content="2022-07-31T00:00:00+09:00"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap"><link rel=stylesheet href=/blog/css/style.css><link rel=stylesheet href=/blog/css/custom.css><link rel="shortcut icon" href=/blog/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-HX0J3DN5S1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-HX0J3DN5S1",{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/blog/ title=チラ裏 rel=home><div class="logo__item logo__text"><div class=logo__title>チラ裏</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>メニュー</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/blog/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/blog/posts/><span class=menu__text>Posts</span></a></li><li class=menu__item><a class=menu__link href=/blog/about><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Docker上でSolargraphを使う</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-07-31T00:00:00+09:00>2022-07-31</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/blog/categories/%E6%8A%80%E8%A1%93%E9%96%A2%E9%80%A3/ rel=category>技術関連</a></span></div></div></header><div class="content post__content clearfix"><p>LSPが登場し様々なLanguage Serverが使えるようになってから、開発する際にはとりあえずLanguage Serverを用意して使えるようにしています。</p><p>ローカル環境で使っているぶんにはいいですが、Dockerで構築した環境にて動かすのは少し面倒なので自分が使っているやり方をメモを残しておこうと思います。</p><h2 id=ゴール>ゴール</h2><p>Docker Composeで構築した環境上で動作するSolargraphを外から使えるようにする。</p><h2 id=環境>環境</h2><p>過去に自分で使っていた環境の一部を切り出して持ってきているので、この記事の内容をコピペしても動かない可能性があります。あくまでどうやったら動く可能性があるかについての参考としてお使いいただけますと幸いです。</p><p>ファイル構成、<code>Dockerfile</code>、<code>docker-compose.yml</code>はそれぞれ以下の様になっているものとします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ tree -L <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── api    <span style=color:#75715e># Railsはこの下</span>
</span></span><span style=display:flex><span>├── docker <span style=color:#75715e># Dockerfileの保存場所</span>
</span></span><span style=display:flex><span>└── docker-compose.yml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Docker data-lang=Docker><span style=display:flex><span><span style=color:#75715e># docker/api/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ruby:3.0.3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update -qq <span style=color:#f92672>&amp;&amp;</span> apt-get install -y build-essential libpq-dev<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> APP_ROOT /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> $APP_ROOT</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> Gemfile $APP_ROOT<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> Gemfile.lock $APP_ROOT<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> bundle install<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#75715e># docker-compose.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>./docker/api</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./api:/app</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>bundle:/usr/local/bundle</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/bin/sh -c &#34;rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -p 3000 -b &#39;0.0.0.0&#39;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;23000:3000&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tty</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>stdin_open</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>bundle</span>:
</span></span></code></pre></div><p>DockerfileにENTRYPOINTやCMDが書いてありませんが、Railsでよくある<code>server.pid</code>を削除するシェルスクリプトや、サーバー起動用のコマンド等であればあっても問題ないと思います。</p><h2 id=solargraphを動かせるようにする>Solargraphを動かせるようにする</h2><p>まずSolargraphを導入していない場合はGemfileに追記をしてインストールを行います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>group <span style=color:#e6db74>:development</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  gem <span style=color:#e6db74>&#39;solargraph&#39;</span>, require: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>次に、<code>docker-compose.yml</code>を以下のようにしてSolargraph用のサービスを用意します。共通化せずにRailsのサービス設定をコピペして、変更が必要な部分だけ適宜書き換えても大丈夫です。</p><p>恐らく使用する環境によると思いますが、筆者の環境ではエディタを閉じるとSolargraphのサービスが正常終了してしまうので、<code>restart: always</code>をつけるようにしています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>x-api-base</span>: <span style=color:#75715e>&amp;api-base</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>./docker/api</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./api:/app</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>bundle:/usr/local/bundle</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tty</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>stdin_open</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*api-base</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/bin/sh -c &#34;rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -p 3000 -b &#39;0.0.0.0&#39;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;23000:3000&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>solargraph</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*api-base</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec solargraph socket --host=0.0.0.0 --port=7658</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;17658:7658&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>bundle</span>:
</span></span></code></pre></div><p>これで<code>docker-compose up</code>した際にRailsアプリと同様の環境でSolargraphサービスが立ち上がるようになります。</p><p>あとは使用しているLSPクライアントに、Solargraphを使用する場合は<code>localhost:17658</code>との通信を行うような設定を記述することで使用ができるようになります。</p><p>例えばvim-lspを使っている場合であれば、以下のように記述をすることで接続ができるようになると思います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strlen</span>(<span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#39;docker ps -q -f name=&#34;solargraph&#34;&#39;</span>)) &gt; <span style=color:#ae81ff>0</span> <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>au</span> <span style=color:#a6e22e>User</span> <span style=color:#a6e22e>lsp_setup</span> <span style=color:#a6e22e>call</span> <span style=color:#a6e22e>lsp</span>#<span style=color:#a6e22e>register_server</span>({<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        \ <span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;solargraph-docker&#39;</span>,<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        \ <span style=color:#e6db74>&#39;tcp&#39;</span>: <span style=color:#e6db74>&#34;localhost:17658&#34;</span>,<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        \ <span style=color:#e6db74>&#39;initialization_options&#39;</span>: {<span style=color:#e6db74>&#34;diagnostics&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>},<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        \ <span style=color:#e6db74>&#39;whitelist&#39;</span>: [<span style=color:#e6db74>&#39;ruby&#39;</span>],<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        \ })<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>endif</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>接続設定を書けたら実際にファイルを開いて試しに書いてみましょう。</p><p>正しく設定が行えていれば基本的な構文の補完は効くと思いますが、他のファイルで定義したクラス等については補完が効かないと思います。<br>(補完が効く場合は下記の設定は読み飛ばしてしまって大丈夫です。)</p><p>LSPの定義内容や実装方法についてほとんど理解していませんが、Solargraphへのメッセージにファイルパスが含まれており筆者の環境では絶対パスが使用されていることを確認しています。</p><p>エディタはローカル環境、SolargraphはDocker環境と違う環境で動いているのでほとんどの場合でファイルの所在に関する情報はうまく伝わらず、補完等一部の機能がうまく動きません。</p><p>ローカルのパスとDocker上のパスを一致させれば問題ないですがめんどくさいので、筆者は以下のようなコマンドを叩きシンボリックリンクを貼って対応しています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose exec solargraph mkdir -p <span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>docker-compose exec solargraph ln -s /app <span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>/api
</span></span></code></pre></div><p>恐らくこれでいい感じにSolargraphが動くようになると思います。</p><h2 id=終わりに>終わりに</h2><p>今回はSolargraphを動かせるようにしましたが、TCPsocketでの通信が行えるLanguage Serverであれば同様の方法で動かせるようになると思います。</p><p>他の通信方法ではまだうまくできていないのでもう少しLSPについて勉強したり、情報収集をしていい感じに動かせるようにしたいです。</p><p>この記事が快適なRubyライフを送る手助けになれば幸いです。</p><h2 id=おまけ>おまけ</h2><p>Docker環境だとdownする度にシンボリックリンクを張り直したり、GemのYARDドキュメント生成のコマンドをいちいち叩くのは面倒だと思います。</p><p>なので筆者は以下の様にMakefileで動かせるようにしています。Makefileおすすめです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-make data-lang=make><span style=display:flex><span>EXEC_BASE<span style=color:#f92672>:=</span> docker-compose exec
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>lsp-init</span><span style=color:#f92672>:</span> solargraph-init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>solargraph-init</span><span style=color:#f92672>:</span> rdoc2yard yard-gems
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>EXEC_BASE<span style=color:#66d9ef>)</span> solargraph mkdir -p <span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>EXEC_BASE<span style=color:#66d9ef>)</span> solargraph ln -s /app <span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>/api
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rdoc2yard</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>EXEC_BASE<span style=color:#66d9ef>)</span> solargraph bundle exec solargraph bundle
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>yard-gems</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>EXEC_BASE<span style=color:#66d9ef>)</span> solargraph bundle exec yard gems
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>.PHONY</span><span style=color:#f92672>:</span> lsp-init solargraph-init rdoc2yard yard-gems
</span></span></code></pre></div></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/blog/tags/ruby/ rel=tag>Ruby</a></li><li class=tags__item><a class="tags__link btn" href=/blog/tags/docker/ rel=tag>Docker</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/blog/posts/tech/2022-07-24-hugo%E3%81%A7%E3%82%B5%E3%82%A4%E3%83%88%E6%A7%8B%E7%AF%89/ rel=prev><span class=pager__subtitle>«&#8201;前の投稿</span><p class=pager__title>Hugoでサイト構築</p></a></div></nav></div><aside class=sidebar><div class="widget-recent widget"><h4 class=widget__title>最近の投稿</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/blog/posts/tech/2022-07-29-docker%E4%B8%8A%E3%81%A7solargraph%E3%82%92%E4%BD%BF%E3%81%86/>Docker上でSolargraphを使う</a></li><li class=widget__item><a class=widget__link href=/blog/posts/tech/2022-07-24-hugo%E3%81%A7%E3%82%B5%E3%82%A4%E3%83%88%E6%A7%8B%E7%AF%89/>Hugoでサイト構築</a></li><li class=widget__item><a class=widget__link href=/blog/posts/test/>Test</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>カテゴリー</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/blog/categories/%E3%81%9D%E3%81%AE%E4%BB%96/>その他</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/blog/categories/%E6%8A%80%E8%A1%93%E9%96%A2%E9%80%A3/>技術関連</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>タグ</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/blog/tags/docker/ title=Docker>Docker (1)</a>
<a class="widget-taglist__link widget__link btn" href=/blog/tags/hugo/ title=Hugo>Hugo (1)</a>
<a class="widget-taglist__link widget__link btn" href=/blog/tags/ruby/ title=Ruby>Ruby (1)</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__links><a class=footer__link href=/blog/privacy>プライバシーポリシー</a></div><div class=footer__copyright>&copy; 2022 Kanon159.
<span class=footer__copyright-credits>このサイトは <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> と <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> テーマで生成されています。</span></div></div></footer></div><script async defer src=/blog/js/menu.js></script></body></html>